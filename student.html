<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–£—á–µ–Ω–∏–∫ - –•–∏–º–∏—è –ö–∞—Ö—É—Ç</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* ... –≤—Å–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è ... */
    </style>
</head>
<body class="student-page">
    <!-- ... HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π ... -->
    
    <div class="student-container">
        <!-- GLASS –≠–ö–†–ê–ù 1: –í–•–û–î -->
        <div id="joinScreen" class="screen active">
            <div class="login-box">
                <div class="logo">üß™</div>
                <h1>–•–ò–ú–ò–Ø –ö–ê–•–£–¢</h1>
                <p class="subtitle">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ –ø–æ —Ö–∏–º–∏–∏. –¢–µ–º–∞: –ö—Ä–µ–º–Ω–∏–π –∏ –µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.</p>
                
                <div class="login-form">
                    <div id="errorContainer"></div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> –í–∞—à–µ –∏–º—è:</label>
                        <input type="text" id="playerName" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                               maxlength="15"
                               autocomplete="off"
                               autocapitalize="words">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-key"></i> –ö–æ–¥ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã (8 —Ü–∏—Ñ—Ä):</label>
                        <div class="code-input-container">
                            <input type="text" 
                                   id="gameCode" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ 8 —Ü–∏—Ñ—Ä"
                                   maxlength="8"
                                   inputmode="numeric"
                                   pattern="[0-9]*"
                                   autocomplete="off">
                            <div class="code-hint">8 —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä: 12345678</div>
                        </div>
                    </div>
                    
                    <button id="joinButton" class="glass-btn btn-join">
                        <i class="fas fa-gamepad"></i> –ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ö –í–ò–ö–¢–û–†–ò–ù–ï
                    </button>
                    
                    <div class="login-info">
                        <p><i class="fas fa-bullhorn"></i> –ö–æ–¥ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ</p>
                        <p><i class="fas fa-mobile-alt"></i> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- GLASS –≠–ö–†–ê–ù 2: –û–ñ–ò–î–ê–ù–ò–ï -->
        <div id="waitingScreen" class="screen">
            <div class="waiting-box">
                <div class="loader"></div>
                <h2>–û–ñ–ò–î–ê–ù–ò–ï...</h2>
                <p>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —Å–∫–æ—Ä–æ –∑–∞–ø—É—Å—Ç–∏—Ç –≤–æ–ø—Ä–æ—Å</p>
                
                <div class="user-info">
                    <div class="info-item">
                        <span>–£—á–∞—Å—Ç–Ω–∏–∫:</span>
                        <strong id="displayName">-</strong>
                    </div>
                    <div class="info-item">
                        <span>–ö–æ–¥ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã:</span>
                        <code id="displayCode">-</code>
                    </div>
                    <div class="info-item">
                        <span>–í–∞—à–∏ –æ—á–∫–∏:</span>
                        <strong id="displayScore">0</strong>
                    </div>
                </div>
                
                <div class="room-info">
                    <p>üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ: <span id="roomPlayers" style="color: #43e97b;">1</span></p>
                </div>
                
                <button onclick="leaveGame()" class="glass-btn btn-leave">
                    <i class="fas fa-sign-out-alt"></i> –í–´–ô–¢–ò –ò–ó –í–ò–ö–¢–û–†–ò–ù–´
                </button>
            </div>
        </div>

        <!-- GLASS –≠–ö–†–ê–ù 3: –í–û–ü–†–û–° -->
        <div id="questionScreen" class="screen">
            <div class="question-box">
                <div class="question-header">
                    <div class="question-meta">
                        <span class="question-type" id="questionType">–•–ò–ú–ò–Ø</span>
                        <span class="question-number">–í–æ–ø—Ä–æ—Å <span id="currentQ">1</span>/30</span>
                    </div>
                </div>
                
                <div class="question-content">
                    <div class="question-text" id="questionText">
                        –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å
                    </div>
                    
                    <div class="options" id="optionsContainer">
                        <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </div>
                    
                    <div class="answer-status" id="answerStatus">
                        –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞
                    </div>
                </div>
            </div>
        </div>

        <!-- GLASS –≠–ö–†–ê–ù 4: –†–ï–ó–£–õ–¨–¢–ê–¢ -->
        <div id="resultScreen" class="screen">
            <div class="result-box">
                <h2>üìä –†–ï–ó–£–õ–¨–¢–ê–¢</h2>
                <div class="result-content" id="resultContent">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...
                </div>
                <div class="next-info">
                    <p>–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å —Å–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç—Å—è</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase config -->
    <script src="firebase-config.js"></script>

    <script>
        // ============================================
        // –û–°–ù–û–í–ù–û–ô –ö–û–î STUDENT
        // ============================================

        let currentGameId = null;
        let playerName = null;
        let currentQuestion = null;
        let hasAnswered = false;
        let selectedOption = null;
        let db = null;
        let gameRef = null;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const joinScreen = document.getElementById('joinScreen');
        const waitingScreen = document.getElementById('waitingScreen');
        const questionScreen = document.getElementById('questionScreen');
        const resultScreen = document.getElementById('resultScreen');
        const playerNameInput = document.getElementById('playerName');
        const gameCodeInput = document.getElementById('gameCode');
        const joinButton = document.getElementById('joinButton');
        const displayName = document.getElementById('displayName');
        const displayCode = document.getElementById('displayCode');
        const displayScore = document.getElementById('displayScore');
        const roomPlayers = document.getElementById('roomPlayers');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const answerStatus = document.getElementById('answerStatus');
        const resultContent = document.getElementById('resultContent');
        const currentQ = document.getElementById('currentQ');
        const questionType = document.getElementById('questionType');
        const errorContainer = document.getElementById('errorContainer');

        // ============================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================

        function showError(message) {
            errorContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
            
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        function showNotification(message, type = "info") {
            const colors = {
                success: '#43e97b',
                error: '#ff416c',
                warning: '#f093fb',
                info: '#4facfe'
            };
            
            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(30px);
                -webkit-backdrop-filter: blur(30px);
                border: 1px solid ${colors[type]}40;
                color: white;
                padding: 18px 28px;
                border-radius: 18px;
                font-weight: 700;
                z-index: 10000;
                animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 15px 50px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 350px;
                border-left: 4px solid ${colors[type]};
            `;
            notification.innerHTML = `
                <span style="font-size: 1.3rem;">${icon[type]}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            }, 3000);
        }

        function switchScreen(screenName) {
            [joinScreen, waitingScreen, questionScreen, resultScreen].forEach(screen => {
                screen.classList.remove('active');
            });
            
            switch(screenName) {
                case 'join':
                    joinScreen.classList.add('active');
                    break;
                case 'waiting':
                    waitingScreen.classList.add('active');
                    break;
                case 'question':
                    questionScreen.classList.add('active');
                    break;
                case 'result':
                    resultScreen.classList.add('active');
                    break;
            }
        }

        // ============================================
        // –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
        // ============================================

        function joinGame() {
            console.log("=== –ü–û–ü–´–¢–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===");
            
            // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
            errorContainer.innerHTML = '';
            
            // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è
            const name = playerNameInput.value.trim();
            const code = gameCodeInput.value.trim();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
            if (!name || name.length < 2) {
                showError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)");
                playerNameInput.focus();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
            if (!code || code.length !== 8 || !/^\d{8}$/.test(code)) {
                showError("–í–≤–µ–¥–∏—Ç–µ 8 —Ü–∏—Ñ—Ä –∫–æ–¥–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã");
                gameCodeInput.focus();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Firebase
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                showError("Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                return;
            }
            
            if (!window.db) {
                window.db = firebase.database();
            }
            
            db = window.db;
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            playerName = name;
            currentGameId = "game_" + code;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            const originalText = joinButton.innerHTML;
            joinButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...';
            joinButton.disabled = true;
            
            console.log(`–ü—Ä–æ–≤–µ—Ä—è—é –∏–≥—Ä—É: ${currentGameId}`);
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
            db.ref(`games/${currentGameId}`).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showError(`–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ —Å –∫–æ–¥–æ–º ${code} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);
                        joinButton.innerHTML = originalText;
                        joinButton.disabled = false;
                        console.log("–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                        return;
                    }
                    
                    const game = snapshot.val();
                    console.log("–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞:", game);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                    if (game.status === "finished") {
                        showError("–≠—Ç–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
                        joinButton.innerHTML = originalText;
                        joinButton.disabled = false;
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º—è –∏–≥—Ä–æ–∫–∞
                    if (game.players && game.players[name]) {
                        showError("–£—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –µ—Å—Ç—å –≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ!");
                        joinButton.innerHTML = originalText;
                        joinButton.disabled = false;
                        return;
                    }
                    
                    console.log("–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é –∏–≥—Ä–æ–∫–∞...");
                    
                    // –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞
                    const playerData = {
                        name: name,
                        joined: Date.now(),
                        score: 0,
                        device: /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? "üì± –¢–µ–ª–µ—Ñ–æ–Ω" : "üíª –ö–æ–º–ø—å—é—Ç–µ—Ä"
                    };
                    
                    return db.ref(`games/${currentGameId}/players/${name}`).set(playerData);
                })
                .then(() => {
                    if (!playerName) return;
                    
                    console.log("–ò–≥—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å UI
                    displayName.textContent = playerName;
                    displayCode.textContent = code;
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —ç–∫—Ä–∞–Ω
                    switchScreen('waiting');
                    
                    // –ù–∞—á–∞—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
                    listenToGame();
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫–∞–∫ ${playerName}`, "success");
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                    joinButton.innerHTML = originalText;
                    joinButton.disabled = false;
                    
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:", error);
                    showError(`–û—à–∏–±–∫–∞: ${error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`);
                    joinButton.innerHTML = originalText;
                    joinButton.disabled = false;
                });
        }

        // ============================================
        // –ü–†–û–°–õ–£–®–ò–í–ê–ù–ò–ï –ò–ì–†–´
        // ============================================

        function listenToGame() {
            if (!currentGameId || !db) {
                console.error("–ù–µ –º–æ–≥—É —Å–ª—É—à–∞—Ç—å –∏–≥—Ä—É: –Ω–µ—Ç ID –∏–ª–∏ DB");
                return;
            }
            
            console.log(`üéÆ –ù–∞—á–∏–Ω–∞—é —Å–ª—É—à–∞—Ç—å –∏–≥—Ä—É: ${currentGameId}`);
            
            gameRef = db.ref(`games/${currentGameId}`);
            
            gameRef.on('value', snapshot => {
                const game = snapshot.val();
                if (!game) {
                    console.log("–ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞");
                    showNotification("–ò–≥—Ä–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º", "info");
                    leaveGame();
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤
                if (game.players) {
                    const playerCount = Object.keys(game.players).length;
                    roomPlayers.textContent = playerCount;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –∏–≥—Ä–æ–∫–∞
                    if (game.players[playerName]) {
                        displayScore.textContent = game.players[playerName].score || 0;
                    }
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
                handleGameStatus(game);
                
            }, error => {
                console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è:", error);
                showNotification("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "error");
            });
        }

        function handleGameStatus(game) {
            const currentQuestionId = game.currentQuestion;
            const status = game.status;
            
            console.log(`–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã: ${status}, –≤–æ–ø—Ä–æ—Å: ${currentQuestionId}`);
            
            switch (status) {
                case "lobby":
                case "waiting":
                    handleLobby();
                    break;
                    
                case "question_active":
                    if (currentQuestionId && (!currentQuestion || currentQuestion.id != currentQuestionId || !hasAnswered)) {
                        handleQuestionActive(game, currentQuestionId);
                    }
                    break;
                    
                case "showing_results":
                    handleShowingResults(game, currentQuestionId);
                    break;
                    
                case "finished":
                    handleGameFinished();
                    break;
            }
        }

        function handleLobby() {
            if (!waitingScreen.classList.contains('active')) {
                switchScreen('waiting');
            }
            
            hasAnswered = false;
            selectedOption = null;
        }

        function handleQuestionActive(game, questionId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ –≤–æ–ø—Ä–æ—Å—ã
            if (!window.QUIZ_DATA || !window.QUIZ_DATA.questions) {
                console.error("QUIZ_DATA –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!");
                showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤", "error");
                return;
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ID –≤–æ–ø—Ä–æ—Å–∞
            const questionNumber = parseInt(questionId);
            
            // –ù–∞–π—Ç–∏ –≤–æ–ø—Ä–æ—Å
            currentQuestion = window.QUIZ_DATA.questions.find(q => q.id === questionNumber);
            
            if (!currentQuestion) {
                console.error(`–í–æ–ø—Ä–æ—Å —Å ID ${questionId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }
            
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω –≤–æ–ø—Ä–æ—Å: ${currentQuestion.text}`);
            
            hasAnswered = false;
            selectedOption = null;
            
            switchScreen('question');
            displayQuestion(currentQuestion);
        }

        function displayQuestion(question) {
            if (!question) return;
            
            const questionIndex = window.QUIZ_DATA.questions.findIndex(q => q.id === question.id) + 1;
            currentQ.textContent = questionIndex;
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∏–ø —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            const difficultyColors = {
                easy: '#43e97b',
                medium: '#f093fb',
                hard: '#ff416c'
            };
            
            questionType.textContent = question.difficulty === 'easy' ? '–õ–Å–ì–ö–ò–ô' : 
                                     question.difficulty === 'medium' ? '–°–†–ï–î–ù–ò–ô' : '–°–õ–û–ñ–ù–´–ô';
            questionType.style.borderColor = difficultyColors[question.difficulty];
            
            questionText.textContent = question.text;
            
            // –û—á–∏—Å—Ç–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã
            optionsContainer.innerHTML = '';
            if (question.options && Array.isArray(question.options)) {
                question.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.innerHTML = `
                        <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                        <span class="option-text">${option}</span>
                    `;
                    button.onclick = () => selectAnswer(index, button);
                    optionsContainer.appendChild(button);
                });
            }
            
            answerStatus.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞";
            answerStatus.style.color = "#4facfe";
        }

        function selectAnswer(answerIndex, buttonElement) {
            if (hasAnswered || !currentQuestion || !currentGameId || !playerName || !db) {
                console.log("–ù–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å —Å–µ–π—á–∞—Å");
                return;
            }
            
            selectedOption = answerIndex;
            
            // –í—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            buttonElement.classList.add('selected');
            
            submitAnswer(answerIndex);
        }

        function submitAnswer(answerIndex) {
            if (hasAnswered) return;
            
            hasAnswered = true;
            
            // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å
            const isCorrect = (answerIndex === currentQuestion.correct);
            
            const answerData = {
                answerIndex: answerIndex,
                isCorrect: isCorrect,
                timestamp: Date.now()
            };
            
            console.log(`–û—Ç–ø—Ä–∞–≤–ª—è—é –æ—Ç–≤–µ—Ç: ${answerIndex}, –ø—Ä–∞–≤–∏–ª—å–Ω–æ: ${isCorrect}`);
            
            db.ref(`games/${currentGameId}/answers/${currentQuestion.id}/${playerName}`).set(answerData)
                .then(() => {
                    console.log("–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
                    
                    if (isCorrect) {
                        answerStatus.innerHTML = '<i class="fas fa-check-circle"></i> –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                        answerStatus.style.color = '#43e97b';
                        
                        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç
                        const points = currentQuestion.points || 1;
                        db.ref(`games/${currentGameId}/players/${playerName}/score`).transaction(score => {
                            return (score || 0) + points;
                        }).then(() => {
                            console.log("–°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω");
                        });
                    } else {
                        answerStatus.innerHTML = '<i class="fas fa-times-circle"></i> –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!';
                        answerStatus.style.color = '#ff416c';
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:", error);
                    answerStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
                    answerStatus.style.color = '#f093fb';
                });
        }

        function handleShowingResults(game, questionId) {
            if (!currentQuestion || currentQuestion.id != questionId) {
                const questionNumber = parseInt(questionId);
                currentQuestion = window.QUIZ_DATA.questions.find(q => q.id === questionNumber);
            }
            
            if (!currentQuestion) return;
            
            switchScreen('result');
            
            // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            db.ref(`games/${currentGameId}/answers/${currentQuestion.id}/${playerName}`).once('value')
                .then(snapshot => {
                    const userAnswer = snapshot.val();
                    showResult(userAnswer, currentQuestion);
                })
                .catch(() => {
                    showResult(null, currentQuestion);
                });
        }

        function showResult(userAnswer, question) {
            let resultHTML = '';
            
            if (!question || !question.options) {
                resultHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</p>';
                resultContent.innerHTML = resultHTML;
                return;
            }
            
            const correctAnswerText = question.options[question.correct];
            
            if (userAnswer && userAnswer.answerIndex >= 0) {
                const isCorrect = userAnswer.isCorrect;
                const userAnswerText = question.options[userAnswer.answerIndex];
                
                resultHTML = `
                    <div style="color: ${isCorrect ? '#43e97b' : '#ff416c'}; font-size: 1.8rem; margin-bottom: 25px; font-weight: 900;">
                        <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                        ${isCorrect ? '–ü–†–ê–í–ò–õ–¨–ù–û!' : '–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û'}
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 8px; font-size: 1rem;">–í–∞—à –æ—Ç–≤–µ—Ç:</div>
                        <div style="color: white; font-size: 1.3rem; font-weight: 700;">${userAnswerText}</div>
                    </div>
                    <div style="background: rgba(67, 233, 123, 0.15); padding: 20px; border-radius: 16px; margin: 15px 0; border: 1px solid rgba(67, 233, 123, 0.3);">
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 8px; font-size: 1rem;">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</div>
                        <div style="color: #43e97b; font-size: 1.3rem; font-weight: 900;">${correctAnswerText}</div>
                    </div>
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="color: rgba(255,255,255,0.85); font-style: italic; font-size: 1.1rem; line-height: 1.5;">${question.explanation || '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
                    </div>
                `;
            } else {
                resultHTML = `
                    <div style="color: #f093fb; font-size: 1.8rem; margin-bottom: 25px; font-weight: 900;">
                        <i class="fas fa-clock"></i> –í–´ –ù–ï –£–°–ü–ï–õ–ò –û–¢–í–ï–¢–ò–¢–¨
                    </div>
                    <div style="background: rgba(67, 233, 123, 0.15); padding: 20px; border-radius: 16px; margin: 15px 0; border: 1px solid rgba(67, 233, 123, 0.3);">
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 8px; font-size: 1rem;">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</div>
                        <div style="color: #43e97b; font-size: 1.3rem; font-weight: 900;">${correctAnswerText}</div>
                    </div>
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="color: rgba(255,255,255,0.85); font-style: italic; font-size: 1.1rem; line-height: 1.5;">${question.explanation || '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
                    </div>
                `;
            }
            
            resultContent.innerHTML = resultHTML;
        }

        function handleGameFinished() {
            switchScreen('result');
            
            db.ref(`games/${currentGameId}/players/${playerName}`).once('value')
                .then(snapshot => {
                    const playerData = snapshot.val();
                    const score = playerData ? playerData.score || 0 : 0;
                    
                    resultContent.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2.2rem; color: #4facfe; margin-bottom: 25px; font-weight: 900;">
                                <i class="fas fa-flag-checkered"></i> –í–ò–ö–¢–û–†–ò–ù–ê –ó–ê–í–ï–†–®–ï–ù–ê
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; margin: 25px 0; border: 2px solid rgba(79, 172, 254, 0.3);">
                                <div style="color: #43e97b; font-size: 3rem; margin-bottom: 10px; font-weight: 900; text-shadow: 0 0 20px rgba(67, 233, 123, 0.3);">${score} –æ—á–∫–æ–≤</div>
                                <div style="color: rgba(255,255,255,0.85); font-size: 1.2rem;">–í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                            </div>
                            <button onclick="location.reload()" class="glass-btn btn-join" style="margin-top: 20px; width: auto; padding: 15px 30px;">
                                <i class="fas fa-redo"></i> –ù–ê–ß–ê–¢–¨ –ó–ê–ù–û–í–û
                            </button>
                        </div>
                    `;
                });
        }

        function leaveGame() {
            console.log("–í—ã—Ö–æ–∂—É –∏–∑ –∏–≥—Ä—ã...");
            
            if (currentGameId && playerName && db) {
                try {
                    // –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è
                    if (gameRef) {
                        gameRef.off('value');
                    }
                    
                    // –£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞
                    db.ref(`games/${currentGameId}/players/${playerName}`).remove()
                        .then(() => {
                            console.log("–ò–≥—Ä–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –∏–≥—Ä—ã");
                        })
                        .catch(error => {
                            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞:", error);
                        });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:", e);
                }
            }
            
            resetGameState();
            switchScreen('join');
            
            showNotification("–í—ã –≤—ã—à–ª–∏ –∏–∑ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã", "info");
        }

        function resetGameState() {
            currentGameId = null;
            playerName = null;
            currentQuestion = null;
            hasAnswered = false;
            selectedOption = null;
            gameRef = null;
            playerNameInput.value = '';
            gameCodeInput.value = '';
            displayScore.textContent = '0';
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log("üéì –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω");
            
            // iOS —Ñ–∏–∫—Å –¥–ª—è —Ñ–æ–∫—É—Å–∞
            setTimeout(() => {
                const nameInput = document.getElementById('playerName');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 500);
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Firebase —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    console.log("‚úÖ Firebase –∑–∞–≥—Ä—É–∂–µ–Ω");
                    window.db = firebase.database();
                } else {
                    console.warn("‚ö†Ô∏è Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
                }
            }, 1000);
            
            // –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–µ
            joinButton.addEventListener('click', joinGame);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Enter
            playerNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    gameCodeInput.focus();
                }
            });
            
            gameCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinGame();
                }
            });
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
            gameCodeInput.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '');
                if (this.value.length > 8) {
                    this.value = this.value.substring(0, 8);
                }
            });
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏
            playerNameInput.addEventListener('input', function() {
                if (this.value.length > 15) {
                    this.value = this.value.substring(0, 15);
                }
            });
            
            // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –∏–º—è
            playerNameInput.focus();
        });

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.joinGame = joinGame;
        window.leaveGame = leaveGame;
        window.selectAnswer = selectAnswer;
    </script>
</body>
</html>
